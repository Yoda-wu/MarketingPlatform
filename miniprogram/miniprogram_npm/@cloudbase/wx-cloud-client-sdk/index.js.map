{"version":3,"sources":["wxCloudClientSDK.cjs.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\r\n\r\n/******************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nfunction __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nvar __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\n\r\nfunction __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, [])).next());\r\n    });\r\n}\r\n\r\nfunction __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nvar WxCloudSDKError = /** @class */ (function (_super) {\r\n    __extends(WxCloudSDKError, _super);\r\n    function WxCloudSDKError(message, extra) {\r\n        var _this = _super.call(this, message) || this;\r\n        _this.name = 'WxCloudSDKError';\r\n        _this.code = extra === null || extra === void 0 ? void 0 : extra.code;\r\n        _this.requestId = extra === null || extra === void 0 ? void 0 : extra.requestId;\r\n        _this.originError = extra === null || extra === void 0 ? void 0 : extra.originError;\r\n        return _this;\r\n    }\r\n    return WxCloudSDKError;\r\n}(Error));\r\n\r\n/**\r\n * 获取全局对象 window\r\n *  小程序中可用, 但小程序中对象信息残缺, 无法访问 navigator 对象, ua 信息也无意义\r\n */\r\nfunction getGlobalObj() {\r\n    // @ts-ignore\r\n    return (typeof window !== 'undefined' && window) || (typeof globalThis !== 'undefined' && globalThis);\r\n}\r\n/** 获取referrer 信息, 担心小程序中报错, 故catch */\r\nfunction getReferrer() {\r\n    try {\r\n        var globalObj = getGlobalObj();\r\n        if (!globalObj)\r\n            return;\r\n        // 浏览器中\r\n        // @ts-ignore\r\n        if (typeof wx === 'undefined') {\r\n            // @ts-ignore\r\n            return getGlobalObj().location.href;\r\n        }\r\n        // 当前页面路由\r\n        // @ts-ignore\r\n        return globalObj.__wxRoute;\r\n    }\r\n    catch (_a) { }\r\n}\r\n/** 获取用户UA, 小程序中使用 getSystemInfo 替代 */\r\nfunction getUserAgent() {\r\n    var globalObj = getGlobalObj();\r\n    // @ts-ignore\r\n    if (globalObj === null || globalObj === void 0 ? void 0 : globalObj.navigator)\r\n        return globalObj.navigator.userAgent;\r\n    // 微信小程序\r\n    // @ts-ignore\r\n    if (typeof wx !== 'undefined' && wx.getSystemInfo) {\r\n        var ua_1;\r\n        // 同步接口\r\n        // @ts-ignore\r\n        wx.getSystemInfo({\r\n            success: function (res) {\r\n                if (!res)\r\n                    return;\r\n                ua_1 = ['brand', 'model', 'version', 'system', 'platform', 'SDKVersion', 'language']\r\n                    .map(function (k) { return \"\".concat(k, \": \").concat(res[k]); })\r\n                    .join(', ');\r\n            }\r\n        });\r\n        return ua_1;\r\n    }\r\n}\r\nvar VERSION = \"1.2.1\";\r\n\r\nvar callDataSource = function (_a) {\r\n    var dataSourceName = _a.dataSourceName, methodName = _a.methodName, params = _a.params, realMethodName = _a.realMethodName, callFunction = _a.callFunction, _b = _a.envType, envType = _b === void 0 ? 'prod' : _b, mode = _a.mode;\r\n    return __awaiter(void 0, void 0, void 0, function () {\r\n        var result, response, requestId, error_1;\r\n        var _c, _d;\r\n        return __generator(this, function (_e) {\r\n            switch (_e.label) {\r\n                case 0:\r\n                    result = {\r\n                        data: {},\r\n                        requestId: ''\r\n                    };\r\n                    _e.label = 1;\r\n                case 1:\r\n                    _e.trys.push([1, 3, , 4]);\r\n                    return [4 /*yield*/, callFunction({\r\n                            name: 'lowcode-datasource',\r\n                            data: {\r\n                                dataSourceName: dataSourceName,\r\n                                methodName: methodName,\r\n                                params: params,\r\n                                userAgent: getUserAgent(),\r\n                                referrer: getReferrer(),\r\n                                'x-sdk-version': VERSION,\r\n                                /**\r\n                                 * todo 移除此字段\r\n                                 */\r\n                                envType: envType,\r\n                                mode: mode\r\n                            }\r\n                        })];\r\n                case 2:\r\n                    response = _e.sent();\r\n                    requestId = ((_c = response === null || response === void 0 ? void 0 : response.result) === null || _c === void 0 ? void 0 : _c.requestId) || (response === null || response === void 0 ? void 0 : response.requestId) || (response === null || response === void 0 ? void 0 : response.requestID);\r\n                    if (response === null || response === void 0 ? void 0 : response.result.code) {\r\n                        throw new WxCloudSDKError(\"\\u3010\\u9519\\u8BEF\\u3011\".concat(response === null || response === void 0 ? void 0 : response.result.message, \"\\n\\u3010\\u64CD\\u4F5C\\u3011\\u8C03\\u7528 models.\").concat(dataSourceName ? \"\".concat(dataSourceName, \".\") : \"\").concat(realMethodName, \"\\n\\u3010\\u9519\\u8BEF\\u7801\\u3011\").concat(response === null || response === void 0 ? void 0 : response.result.code, \"\\n\\u3010\\u8BF7\\u6C42ID\\u3011\").concat(requestId || 'N/A'), {\r\n                            code: response === null || response === void 0 ? void 0 : response.result.code,\r\n                            requestId: requestId\r\n                        });\r\n                    }\r\n                    else {\r\n                        result.data = ((_d = response === null || response === void 0 ? void 0 : response.result) === null || _d === void 0 ? void 0 : _d.data) || {};\r\n                        result.requestId = requestId;\r\n                    }\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    error_1 = _e.sent();\r\n                    if (error_1.name === 'WxCloudSDKError') {\r\n                        throw error_1;\r\n                    }\r\n                    else {\r\n                        console.log(error_1);\r\n                        throw new WxCloudSDKError(\"\\u3010\\u9519\\u8BEF\\u3011\".concat(error_1.message, \"\\n      \\u3010\\u64CD\\u4F5C\\u3011\\u8C03\\u7528 models.\").concat(dataSourceName ? \"\".concat(dataSourceName, \".\") : \"\").concat(realMethodName, \"\\n      \\u3010\\u8BF7\\u6C42ID\\u3011N/A\"), {\r\n                            code: 'UnknownError',\r\n                            originError: error_1\r\n                        });\r\n                    }\r\n                case 4: return [2 /*return*/, result];\r\n            }\r\n        });\r\n    });\r\n};\r\nvar runMysqlCommand = function (_a) {\r\n    var sql = _a.sql, params = _a.params, config = _a.config, callFunction = _a.callFunction, _b = _a.unsafe, unsafe = _b === void 0 ? false : _b;\r\n    return __awaiter(void 0, void 0, void 0, function () {\r\n        return __generator(this, function (_c) {\r\n            return [2 /*return*/, callDataSource({\r\n                    realMethodName: '$runSQL',\r\n                    methodName: 'callWedaApi',\r\n                    params: {\r\n                        action: 'RunMysqlCommand',\r\n                        data: {\r\n                            sqlTemplate: sql,\r\n                            config: config,\r\n                            parameter: unsafe\r\n                                ? ''\r\n                                : Object.entries(params || {}).reduce(function (list, _a) {\r\n                                    var key = _a[0], value = _a[1];\r\n                                    if (value !== undefined) {\r\n                                        var type = \"OBJECT\" /* EQUERY_PARAM_TYPE.OBJECT */;\r\n                                        var typeofValue = typeof value;\r\n                                        switch (typeofValue) {\r\n                                            case 'boolean': {\r\n                                                type = \"BOOLEAN\" /* EQUERY_PARAM_TYPE.BOOLEAN */;\r\n                                                break;\r\n                                            }\r\n                                            case 'number': {\r\n                                                type = \"NUMBER\" /* EQUERY_PARAM_TYPE.NUMBER */;\r\n                                                break;\r\n                                            }\r\n                                            case 'string': {\r\n                                                type = \"STRING\" /* EQUERY_PARAM_TYPE.STRING */;\r\n                                                break;\r\n                                            }\r\n                                            default: {\r\n                                                if (Array.isArray(value)) {\r\n                                                    type = \"ARRAY\" /* EQUERY_PARAM_TYPE.ARRAY */;\r\n                                                }\r\n                                                else {\r\n                                                    type = \"OBJECT\" /* EQUERY_PARAM_TYPE.OBJECT */;\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                        list.push({\r\n                                            key: key,\r\n                                            type: type,\r\n                                            value: type === \"STRING\" /* EQUERY_PARAM_TYPE.STRING */ ? value : JSON.stringify(value)\r\n                                        });\r\n                                    }\r\n                                    return list;\r\n                                }, []) || []\r\n                        }\r\n                    },\r\n                    callFunction: callFunction,\r\n                    mode: 'sdk'\r\n                })];\r\n        });\r\n    });\r\n};\r\n\r\nvar CRUD_METHODS = {\r\n    create: {\r\n        methodName: 'wedaCreateV2'\r\n    },\r\n    createMany: {\r\n        methodName: 'wedaBatchCreateV2'\r\n    },\r\n    update: {\r\n        methodName: 'wedaUpdateV2'\r\n    },\r\n    upsert: {\r\n        methodName: 'wedaUpsertV2'\r\n    },\r\n    updateMany: {\r\n        methodName: 'wedaBatchUpdateV2'\r\n    },\r\n    \"delete\": {\r\n        methodName: 'wedaDeleteV2'\r\n    },\r\n    deleteMany: {\r\n        methodName: 'wedaBatchDeleteV2'\r\n    },\r\n    get: {\r\n        methodName: 'wedaGetItemV2',\r\n        defaultParams: {\r\n            filter: {\r\n                where: {}\r\n            },\r\n            select: {\r\n                $master: true\r\n            }\r\n        }\r\n    },\r\n    list: {\r\n        methodName: 'wedaGetRecordsV2',\r\n        defaultParams: {\r\n            filter: {\r\n                where: {}\r\n            },\r\n            select: {\r\n                $master: true\r\n            }\r\n        }\r\n    }\r\n};\r\nvar generateClientByDataSourceName = function (dataSourceName, callFunction) {\r\n    var client = new Proxy({}, {\r\n        get: function (target, methodName) {\r\n            var operation = CRUD_METHODS[methodName];\r\n            if (!operation) {\r\n                var error = new Error(\"\\u4E0D\\u652F\\u6301\\u7684\\u64CD\\u4F5C: \".concat(methodName));\r\n                throw new WxCloudSDKError(error.message || 'Unknown error occurred', {\r\n                    originError: error,\r\n                    code: 'NotSupported',\r\n                    requestId: 'N/A'\r\n                });\r\n            }\r\n            return function (params) { return __awaiter(void 0, void 0, void 0, function () {\r\n                var effectiveParams, rawData, result, dataKey;\r\n                var _a;\r\n                return __generator(this, function (_b) {\r\n                    switch (_b.label) {\r\n                        case 0:\r\n                            effectiveParams = __assign(__assign({}, (operation.defaultParams || {})), (params || {}));\r\n                            return [4 /*yield*/, callDataSource({\r\n                                    callFunction: callFunction,\r\n                                    dataSourceName: dataSourceName,\r\n                                    methodName: operation.methodName,\r\n                                    realMethodName: methodName,\r\n                                    params: effectiveParams,\r\n                                    envType: params === null || params === void 0 ? void 0 : params.envType\r\n                                })];\r\n                        case 1:\r\n                            rawData = _b.sent();\r\n                            result = { data: {} };\r\n                            dataKey = operation.responseKey;\r\n                            result.data = dataKey ? (_a = rawData === null || rawData === void 0 ? void 0 : rawData.data) === null || _a === void 0 ? void 0 : _a[dataKey] : rawData === null || rawData === void 0 ? void 0 : rawData.data;\r\n                            return [2 /*return*/, result];\r\n                    }\r\n                });\r\n            }); };\r\n        }\r\n    });\r\n    return client;\r\n};\r\n// 使用 TypeScript 的 Proxy 来定义一个动态的客户端\r\nvar generateClient = function (callFunction) {\r\n    var rawQueryClient = {\r\n        $runSQL: function (sql, params, config) {\r\n            return __awaiter(this, void 0, void 0, function () {\r\n                var res;\r\n                return __generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0: return [4 /*yield*/, runMysqlCommand({\r\n                                sql: sql,\r\n                                params: params,\r\n                                config: __assign(__assign({}, config), { preparedStatements: true }),\r\n                                callFunction: callFunction\r\n                            })];\r\n                        case 1:\r\n                            res = _a.sent();\r\n                            return [2 /*return*/, res];\r\n                    }\r\n                });\r\n            });\r\n        },\r\n        $runSQLRaw: function (sql, config) {\r\n            return __awaiter(this, void 0, void 0, function () {\r\n                var res;\r\n                return __generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0: return [4 /*yield*/, runMysqlCommand({\r\n                                sql: sql,\r\n                                params: [],\r\n                                config: __assign(__assign({}, config), { preparedStatements: false }),\r\n                                callFunction: callFunction\r\n                            })];\r\n                        case 1:\r\n                            res = _a.sent();\r\n                            return [2 /*return*/, res];\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    };\r\n    return new Proxy({}, {\r\n        get: function (target, prop) {\r\n            if (typeof prop === 'string') {\r\n                if (rawQueryClient.hasOwnProperty(prop)) {\r\n                    return rawQueryClient[prop];\r\n                }\r\n                // 返回一个函数，这个函数接受任意参数并返回一个 Promise\r\n                return generateClientByDataSourceName(prop, callFunction);\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nfunction init(cloud) {\r\n    if (!cloud) {\r\n        throw new Error('cloud is required');\r\n    }\r\n    if (!cloud.callFunction) {\r\n        throw new Error('cloud.callFunction is required');\r\n    }\r\n    var OrmClientImpl = generateClient(cloud.callFunction.bind(cloud));\r\n    cloud.models = OrmClientImpl;\r\n    return cloud;\r\n}\r\n\r\nexports.init = init;\r\n"]}